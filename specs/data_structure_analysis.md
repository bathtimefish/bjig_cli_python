# BraveJIGプロトコル完全データ構造解析

**作成日**: 2025-07-13  
**目的**: ルーター仕様書とモジュール仕様書の連携による完全なデータ構造の理解

## 1. アップリンク通知の完全なデータ構造

### 全体構造
アップリンク通知は**ルーター共通ヘッダ + モジュール固有センサーデータ**の構造：

```
[ルーター共通ヘッダ 20byte] + [モジュール固有センサーデータ n byte]
```

### 1.1 ルーター共通ヘッダ (ルーター仕様書 5-1-1)

| Index | フィールド名 | サイズ | 説明 | エンディアン |
|-------|-------------|--------|------|-------------|
| 0 | Protocol Version | 1byte | 0x01 固定 | - |
| 1 | Type | 1byte | 0x00 (アップリンク通知) | - |
| 2-3 | Data Length | 2byte | Index 21以降のサイズ | リトル |
| 4-7 | Unix Time | 4byte | Unix時間 | リトル |
| 8-15 | Device ID | 8byte | 送信元モジュールID | リトル |
| 16-17 | Sensor ID | 2byte | センサー種別ID | リトル |
| 18 | RSSI | 1byte | Bluetooth LE受信強度 | - |
| 19-20 | Order | 2byte | モジュール送信カウント | リトル |

### 1.2 モジュール固有センサーデータ (各モジュール仕様書 5-1)

#### 温湿度モジュール (Sensor ID: 0x0123)
```
Index 21～: センサー情報
| フィールド | サイズ | 説明 | エンディアン |
|-----------|--------|------|-------------|
| SensorID | 2byte | 0x0123 | リトル |
| Sequence No | 2byte | 0x0000~0xFFFF | リトル |
| BatteryLevel | 1byte | バッテリー残量(%) | - |
| Sampling | 1byte | サンプリング周期 | - |
| Time | 4byte | センサーリード時刻 | リトル |
| sampleNum | 2byte | サンプル数 | リトル |
| measuredata[0] | 8byte | 温度(4byte Float) + 湿度(4byte Float) | リトル |
| ... | ... | 繰り返し | リトル |
| measuredata[n-1] | 8byte | 温度(4byte Float) + 湿度(4byte Float) | リトル |
```

#### 加速度モジュール (Sensor ID: 0x0122)
```
Index 21～: センサー情報
| フィールド | サイズ | 説明 | エンディアン |
|-----------|--------|------|-------------|
| SensorID | 2byte | 0x0122 | リトル |
| Sequence No | 2byte | 0x0000~0xFFFF | リトル |
| BatteryLevel | 1byte | バッテリー残量(%) | - |
| Sampling | 1byte | サンプリング周期 | - |
| Time | 4byte | センサーリード時刻 | リトル |
| sampleNum | 2byte | サンプル数 | リトル |
| acceleData[0] | 12byte | X軸(4byte Float) + Y軸(4byte Float) + Z軸(4byte Float) | リトル |
| ... | ... | 繰り返し | リトル |
| acceleData[n-1] | 12byte | X軸(4byte Float) + Y軸(4byte Float) + Z軸(4byte Float) | リトル |
```

## 2. ダウンリンクリクエストの完全なデータ構造

### 全体構造 (ルーター仕様書 5-2-1)
```
[ルーター共通ヘッダ 21byte] + [モジュール固有コマンドデータ n byte]
```

### 2.1 ルーター共通ヘッダ

| Index | フィールド名 | サイズ | 説明 | エンディアン |
|-------|-------------|--------|------|-------------|
| 0 | Protocol Version | 1byte | 0x01 固定 | - |
| 1 | Type | 1byte | 0x00 (ダウンリンクリクエスト) | - |
| 2-3 | Data Length | 2byte | Index 21以降のサイズ | リトル |
| 4-7 | Unix Time | 4byte | Unix時間 | リトル |
| 8-15 | Device ID | 8byte | 送信先モジュールID | リトル |
| 16-17 | Sensor ID | 2byte | センサー種別ID | リトル |
| 18 | CMD | 1byte | コマンド種別 | - |
| 19-20 | Order | 2byte | 0x00 固定 | リトル |

### 2.2 モジュール固有コマンドデータ例

#### 即時Uplink要求 (CMD: 0x00)
```
Index 21～: データなし (Data Length = 0)
```

#### パラメータ設定要求 (CMD: 0x05) - 温湿度モジュール
```
Index 21～:
| フィールド | サイズ | 説明 | エンディアン |
|-----------|--------|------|-------------|
| SensorID | 2byte | 0x0123 | リトル |
| TimeZone | 1byte | タイムゾーン設定 | - |
| BLE Mode | 1byte | Bluetooth LE通信モード | - |
| Tx Power | 1byte | 送信電波出力 | - |
| Advertise Interval | 2byte | Advertise間隔 | リトル |
| Sensor Uplink Interval | 4byte | センサーUplink間隔 | リトル |
| Sensor Read Mode | 1byte | 計測モード | - |
| Sampling | 1byte | サンプリング周期 | - |
| （その他パラメータ） | ... | ... | ... |
```

## 3. ダウンリンクレスポンスの完全なデータ構造

### 固定19バイト構造 (ルーター仕様書 5-1-2)

| Index | フィールド名 | サイズ | 説明 | エンディアン |
|-------|-------------|--------|------|-------------|
| 0 | Protocol Version | 1byte | 0x01 固定 | - |
| 1 | Type | 1byte | 0x01 (ダウンリンクレスポンス) | - |
| 2-5 | Unix Time | 4byte | Unix時間 | リトル |
| 6-13 | Device ID | 8byte | 対象モジュールID | リトル |
| 14-15 | Sensor ID | 2byte | センサー種別ID | リトル |
| 16-17 | Order | 2byte | リクエストのOrderをコピー | リトル |
| 18 | CMD | 1byte | 対応するリクエストCMD | - |
| 19 | Result | 1byte | 処理結果 (0x00=成功、0x01~0x09=エラー) | - |

**注意**: ダウンリンクレスポンスには**Data Lengthフィールドがない**（固定長のため）

## 4. JIG INFOリクエスト/レスポンスの特殊構造

### 4.1 JIG INFOリクエスト (ルーター仕様書 5-2-2)
**重要**: Data Lengthフィールドを持たない特殊構造

| Index | フィールド名 | サイズ | 説明 | エンディアン |
|-------|-------------|--------|------|-------------|
| 0 | Protocol Version | 1byte | 0x01 固定 | - |
| 1 | Type | 1byte | 0x01 (JIG INFOリクエスト) | - |
| 2 | CMD | 1byte | JIG INFOコマンド | - |
| 3-6 | Local Time | 4byte | 日本時間(UTC+9) | リトル |
| 7-10 | Unix Time | 4byte | Unix時間 | リトル |

### 4.2 JIG INFOレスポンス (ルーター仕様書 5-1-3)
**重要**: Data Lengthフィールドを持たない特殊構造

| Index | フィールド名 | サイズ | 説明 | エンディアン |
|-------|-------------|--------|------|-------------|
| 0 | Protocol Version | 1byte | 0x01 固定 | - |
| 1 | Type | 1byte | 0x02 (JIG INFOレスポンス) | - |
| 2-5 | Unix Time | 4byte | Unix時間 | リトル |
| 6 | CMD | 1byte | リクエストのCMD | - |
| 7-14 | Router Device ID | 8byte | ルーターのDevice ID | リトル |
| 15～ | Data | n byte | CMD別可変長データ | リトル |

## 5. センサーID一覧

| センサー種別 | Sensor ID | 型番 |
|-------------|-----------|------|
| 照度モジュール | 0x0121 | BJ-MD-LUX-01 |
| 加速度モジュール | 0x0122 | BJ-MD-S3-01 |
| 温湿度モジュール | 0x0123 | BJ-MD-TH-01 |
| 気圧モジュール | 0x0124 | BJ-MD-BP-01 |
| 距離モジュール | 0x0125 | BJ-MD-RA-01 |
| ドライ接点入力 | 0x0126 | BJ-MD-DCI-01 |
| ウェット接点入力 | 0x0127 | BJ-MD-WCI-01 |
| 2ch接点出力 | 0x0128 | BJ-MD-CO-01 |

## 6. データ長計算の正しい理解

### Data Lengthの対象範囲
- **アップリンク通知**: Index 21以降のセンサーデータ部分のサイズ
- **ダウンリンクリクエスト**: Index 21以降のコマンドデータ部分のサイズ
- **JIG INFO系**: Data Lengthフィールド自体が存在しない

### 実装時の注意点
1. **エンディアン処理**: 全てのマルチバイトデータはリトルエンディアン
2. **固定長 vs 可変長**: JIG INFO系は固定長、その他は可変長
3. **データ透過性**: ルーターはセンサーデータ内容を解釈せず透過転送
4. **Order管理**: アップリンクは各モジュールが管理、ダウンリンクは0x00固定

## 7. テストコード実装要件

### 7.1 必須実装項目
1. **正確なバイト配列生成**: 各プロトコル構造の正確な実装
2. **エンディアン処理**: struct.pack('<H'), struct.pack('<L')等の使用
3. **センサーデータ生成**: 各モジュール仕様に準拠したダミーデータ生成
4. **エラーハンドリング**: Result値による適切なレスポンス生成

### 7.2 検証ポイント
1. **プロトコル準拠性**: バイト配列の正確性
2. **非同期動作**: アップリンク通知の継続性
3. **データ整合性**: Data Lengthと実データサイズの一致
4. **エラー境界**: 不正なSensor ID、CMD等への対応

この文書は、BraveJIGルーター実機テスト用のテストコード作成において、正確なプロトコル実装を行うための完全なリファレンスとして機能します。
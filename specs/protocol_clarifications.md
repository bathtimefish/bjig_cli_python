# BraveJIG プロトコル仕様補完

このファイルは、公式仕様書に明記されていないが、メーカー問い合わせや実装過程で判明した重要な仕様情報を記録します。

## データエンディアン形式

**確認日**: 2025-07-07  
**確認方法**: メーカー問い合わせ  
**状況**: 公式仕様書に明記なし

### 仕様
- **全てのマルチバイトデータはリトルエンディアン形式**

### 対象フィールド
以下の2byte以上のフィールドは全てリトルエンディアン：

| フィールド名 | サイズ | 説明 |
|-------------|--------|------|
| Data Length | 2byte | ペイロードサイズ |
| Unix Time | 4byte | タイムスタンプ |
| Device ID | 8byte | デバイス識別子 |
| Sensor ID | 2byte | センサー識別子 |
| Order | 2byte | データ順序番号 |
| Local Time | 4byte | ローカル時間 |
| Total Length | 4byte | DFU総サイズ |

### 実装例
```python
# 正しい実装（リトルエンディアン指定）
struct.pack('<H', data_length)    # 2byte
struct.pack('<L', unix_time)      # 4byte  
struct.pack('<Q', device_id_int)  # 8byte

# データ解析
data_length = struct.unpack('<H', data[2:4])[0]
unix_time = struct.unpack('<L', data[4:8])[0]
```

### 注意事項
- 公式仕様書には記載されていないため、実装時は要注意
- 他のIoTプロトコルではビッグエンディアンが使用される場合もある
- テスト時は実機との動作比較で検証が必要

## JIG INFOリクエストの特殊仕様

**確認日**: 2025-07-07  
**確認方法**: 仕様レビュー指摘  
**状況**: 実装に誤りあり、修正が必要

### 重要な仕様補完

#### 1. プロトコル構造の違い
JIG INFOリクエストは他のコマンドと異なり、**Data Lengthフィールドを持たない**

```
正しい構造:
| Protocol Version (1) | Type (1) | CMD (1) | Local Time (4) | Unix Time (4) |

誤った理解（他コマンドと同様と仮定）:
| Protocol Version (1) | Type (1) | Data Length (2) | Unix Time (4) | ... |
```

#### 2. 時刻管理システム
**Router内部クロックの仕様:**
- **Routerは独立したクロックを持たない**
- **外部からの時刻設定が必須**

**時刻データの用途:**
1. **時刻設定**: コマンド送信時にRouterの内部時刻を設定
2. **妥当性チェック**: 以降のコマンドの時刻データとRouter内部時刻を照合してコマンドの正当性を検証

**Local Time vs Unix Time:**
- **Local Time**: 日本時間（UTC+9）でRouter内部時刻を設定
- **Unix Time**: 標準Unix時間で時刻妥当性をチェック

#### 3. JIG INFOレスポンスも同様の特殊構造
JIG INFOレスポンスも**Data Lengthフィールドを持たない**

```
正しい構造:
| Protocol Version (1) | Type (1) | Unix Time (4) | CMD (1) | Router Device ID (8) | Data (n) |

誤った理解:
| Protocol Version (1) | Type (1) | Data Length (2) | Unix Time (4) | CMD (1) | Router Device ID (8) | Data (n) |
```

### 実装への影響
1. JIG INFOリクエストパーサーの修正が必要
2. JIG INFOレスポンスビルダーの修正が必要
3. Router内部時刻管理機能の実装が必要  
4. コマンド時刻妥当性チェック機能の実装が必要
5. 固定長解析ロジックの実装が必要（Data Length依存からの脱却）

## アップリンク通知のData Length仕様

**確認日**: 2025-07-07  
**確認方法**: 仕様レビュー指摘  
**状況**: Data Length計算の理解に誤りあり

### 正しいData Length仕様

**Data Lengthの対象範囲:**
- Data Lengthは `21~ Data (n byte)` 部分（センサーデータ部分）のみのサイズ
- **各BraveJIGモジュールの仕様に依存する可変長**
- ルーターにとっては **read only** な値（モジュールが決定）

```
誤った理解:
Data Length = Device ID(8) + Sensor ID(2) + RSSI(1) + Order(2) + Data = 13 + len(data)

正しい理解:
Data Length = len(data) のみ（Index 21以降のセンサーデータ部分）
```

### データフロー
1. **BraveJIGモジュール** がセンサーデータサイズを決定
2. **Router** はそのデータを受信してData Lengthをそのまま転送
3. **ホストアプリケーション** が各モジュール仕様書に基づいてデータ解析

### Order フィールドの正しい仕様

**Order フィールドの用途:**
- **各センサーモジュールのデータ送信回数カウント**
- ルーターにとっては **read only** な値（モジュールが管理）

```
誤った理解:
Order = データ分割時の順序番号（0x00から開始、最後は0xFFFF）

正しい理解:
Order = センサーモジュールが自身で管理する送信カウンター
```

### ルーターの役割の再確認
ルーターは以下の値を **読み取り専用** で転送：
- **Data Length**: センサーデータサイズ（モジュールが決定）
- **Order**: 送信カウント（モジュールが管理）
- **Device ID**: 送信元モジュール識別子
- **Sensor ID**: センサータイプ

ルーターが付加する値：
- **RSSI**: Bluetooth LE受信強度（ルーターが測定）

### 実装への影響
1. アップリンク通知ビルダーでのData Length計算修正が必要
2. Order フィールドの管理方法修正が必要（分割順序→送信カウント）
3. 各センサーモジュールの仕様書調査が必要
4. モジュール別のデータ長・送信カウント管理機能が必要

## ダウンリンクリクエストのData Length仕様

**確認日**: 2025-07-07  
**確認方法**: 仕様レビュー指摘  
**状況**: Data Length計算の理解に誤りあり

### 正しいData Length仕様

**ダウンリンクリクエストの用途:**
- **シリアル送信元（ホストアプリケーション）からモジュールへの要求コマンド**
- モジュール設定更新、パラメータ変更等

**Data Lengthの対象範囲:**
- Data Lengthは `21~ Data (n byte)` 部分（コマンドパラメータ部分）のみのサイズ
- **各センサーモジュールの仕様に依存する可変長**
- **送信するコマンドによって動的に変化**

```
誤った理解:
Data Length = Device ID(8) + Sensor ID(2) + CMD(1) + Order(2) + Data = 13 + len(data)

正しい理解:
Data Length = len(data) のみ（Index 21以降のコマンドパラメータ部分）
```

### データフロー
1. **ホストアプリケーション** が要求コマンドとData Lengthを決定
2. **Router** がBluetooth LE経由でモジュールに転送
3. **モジュール** がコマンドを実行してレスポンス返信
4. **Router** がレスポンスをホストに転送

### 実装への影響
1. ダウンリンクリクエストパーサーでのData Length理解修正が必要
2. 各センサーモジュールのコマンド仕様書調査が必要
3. コマンド別の可変長データ処理機能が必要

### Order フィールドの実装方針

**エミュレーター実装では:**
- **ダウンリンクリクエスト/レスポンスのOrderフィールドは `0x00` 固定**
- アップリンク通知のOrderは各仮想モジュールが送信カウントを管理

## ダウンリンクレスポンスの仕様

**確認日**: 2025-07-07  
**確認方法**: 仕様レビュー指摘  
**状況**: ダウンリンクレスポンス構造の確認

### ダウンリンクレスポンスの用途
- **ダウンリンクリクエストの処理結果通知**
- 正常処理/エラー情報をシリアル送信元に返信

### プロトコル構造
```
| Protocol Version (1) | Type (1) | Unix Time (4) | Device ID (8) | Sensor ID (2) | Order (2) | CMD (1) | Result (1) |
```

**注意**: この構造はダウンリンクレスポンス用です。JIG INFOレスポンスの構造については80-85行目を参照。

**重要な特徴:**
- **Data Lengthフィールドなし**（固定長のため）
- **固定19バイト構造** (1+1+4+8+2+2+1=19バイト)
- **Result値**: 0x00=成功、0x01-0x09=各種エラー

### データフロー
1. **ホスト** → ダウンリンクリクエスト → **Router** → **モジュール**
2. **モジュール** → 処理結果 → **Router** → ダウンリンクレスポンス → **ホスト**

### 実装への影響
1. ダウンリンクレスポンス構造の修正（Data Length削除）
2. 固定長19バイトでの解析・生成処理
3. Result値による適切なエラーハンドリング

## 非同期処理とデータフローの重要仕様

**確認日**: 2025-07-07  
**確認方法**: 仕様レビュー説明  
**状況**: エミュレーター開発の核心仕様

### 基本動作パターン
**ペアリング済みモジュールの継続動作:**
- **10秒間隔でアップリンク通知を送信**
- **ルーター起動中は無限ループで継続**
- **他のコマンド処理と非同期で実行**

### 非同期処理フロー

#### ダウンリンクリクエスト処理
```
1. ダウンリンクリクエスト → ルーター受信
2. (処理中にアップリンク通知(10秒間隔)が送信される場合あり)
3. ダウンリンクレスポンス → シリアル送信元
4. アップリンク通知(10秒間隔) → 継続送信
```

#### JIG INFOリクエスト処理  
```
1. JIG INFOリクエスト → ルーター受信
2. (処理中にアップリンク通知(10秒間隔)が送信される場合あり)
3. JIG INFOレスポンス → シリアル送信元  
4. アップリンク通知(10秒間隔) → 継続送信
```

### 実装への重要な影響

**エミュレーターが模擬すべき動作:**
1. **独立したアップリンクタイマー**: 10秒間隔の継続送信
2. **非同期コマンド処理**: リクエスト処理中もアップリンクは停止しない
3. **タイミング競合**: レスポンス送信とアップリンク送信の競合状態
4. **シリアル送信順序**: 複数メッセージの正確な送信順序制御

### 技術的課題
1. マルチスレッド処理での同期制御
2. シリアル送信のキューイング機構
3. タイマー管理とコマンド処理の独立性
4. 実機と同等のタイミング再現

### 詳細仕様の補完

#### 1. 送信優先度とタイミング制御
**同時送信時の優先順序:**
- **レスポンス送信が優先**（ダウンリンクレスポンス、JIG INFOレスポンス）
- **アップリンク通知は後続で送信**
- **OSやPythonスレッド処理に委ねて良い**

#### 2. 複数モジュールのアップリンクタイミング
**各モジュール独立の10秒タイマー:**
- **10秒タイマーはモジュール側で管理**
- **各モジュールが独立してアップリンク送信**
- **エミュレーターでは全モジュールのアップリンク通知を実装**

**通常動作時の実装例:**
```
モジュールA: 00秒, 10秒, 20秒, 30秒...
モジュールB: 03秒, 13秒, 23秒, 33秒...  
モジュールC: 07秒, 17秒, 27秒, 37秒...
```

**注意**: この例は通常動作時です。ルーター起動時については下記の「ルーター起動時のアップリンクタイミング」を参照。

#### 3. エラー時の継続動作
**ダウンリンクエラー発生時:**
- **アップリンク通知は停止しない**
- **各モジュールの10秒タイマーは継続**
- **エラーは独立した処理系**

### エミュレーター実装設計

**必要なコンポーネント:**
1. **モジュール別独立タイマー**: 各仮想モジュールが10秒間隔を管理
2. **送信優先度キュー**: レスポンス優先、アップリンク後続
3. **非同期送信制御**: 複数タイマーからの同時送信制御
4. **エラー独立性**: コマンドエラーがアップリンクに影響しない設計

### JIG INFO START/STOPによるアップリンク制御

#### START/STOPの影響
**JIG INFO STOPリクエスト:**
- **全モジュールのアップリンク通知が停止**
- **各モジュールの10秒タイマーも停止**

**JIG INFO STARTリクエスト:**  
- **全モジュールのアップリンク通知ループが開始**
- **各モジュールの10秒タイマーが再開**

### ペアリングとアップリンク開始
**ペアリング追加時:**
- **物理的操作でのみ実行可能**
- **エミュレーターでは実装対象外**（ソフトウェアでは実現不可能）
- **即時アップリンク開始仕様は考慮不要**

### ルーター起動時のアップリンクタイミング

#### 実機の動作
**実際のルーター:**
- **各モジュールのタイマーは独立**
- **起動後のアップリンク通知はバラバラに発火**
- **モジュール側タイミングに依存**

#### エミュレーター実装方針
**起動時のタイミング分散:**
- **各モジュールごとに1秒ずつ開始タイミングをずらす**
- **完全な模擬は不要、実用的な分散で十分**

**実装例:**
```
モジュールA: ルーター起動 + 1秒後に開始 → 1秒, 11秒, 21秒...
モジュールB: ルーター起動 + 2秒後に開始 → 2秒, 12秒, 22秒...  
モジュールC: ルーター起動 + 3秒後に開始 → 3秒, 13秒, 23秒...
```

### エミュレーター制御フロー

#### 1. ルーター起動
1. 各仮想モジュールを1秒間隔で初期化
2. START状態なら各モジュールタイマー開始
3. STOP状態なら待機状態で保持

#### 2. JIG INFO START受信時
1. 全モジュールタイマーを開始
2. 各モジュールは即座に10秒間隔でアップリンク開始

#### 3. JIG INFO STOP受信時  
1. 全モジュールタイマーを停止
2. アップリンク通知の送信を停止

## デバイス間関係性とデータフロー

**確認日**: 2025-07-07  
**確認方法**: 仕様レビュー説明  
**状況**: システム全体の役割分担の理解

### デバイス役割分担

#### 1. Router（ルーター）
**役割**: 通信ブリッジデバイス
- **モジュール ↔ ホストアプリケーション間の中継**
- **Bluetooth LE** ↔ **USBシリアル通信** のプロトコル変換
- **アップリンク**: モジュール→ルーター→ホストアプリ
- **ダウンリンク**: ホストアプリ→ルーター→モジュール
- **JIG INFO**: ホストアプリ↔ルーター（モジュール関与なし）

#### 2. Module（モジュール）
**役割**: センサーデータ送信デバイス
- **センサーデータの定期送信**（10秒間隔）
- **各モジュール固有のセンサーデータレイアウト**（仕様書参照）
- **ダウンリンクコマンドの受信・実行**
- **独立したタイマー管理**

#### 3. Host Application（ホストアプリケーション）
**役割**: システム制御・データ利用者
- **ルーターのユーザー**
- **シリアル通信でバイト配列コマンド送信**
- **定期的なアップリンク通知受信**
- **ダウンリンクリクエスト・JIG INFOリクエストの送信**

### データフロー図
```
[Module A] ──┐
[Module B] ──┤ Bluetooth LE
[Module C] ──┘
             │
             ▼
         [Router] ←→ USB Serial ←→ [Host Application]
         (Emulator)                (Serial User)
```

### エミュレーター実装観点

#### Router Emulatorが模擬すべき機能
1. **Bluetooth LE通信**: 仮想モジュールとの内部通信
2. **USBシリアル通信**: ホストアプリとの実際の通信
3. **プロトコル変換**: アップリンク通知へのヘッダー追加
4. **JIG INFO処理**: ルーター自身の設定・状態管理

### 開発背景とホストアプリケーション

#### プロジェクトの目的
**エミュレーター開発の背景:**
- **現時点でBraveJIGの象徴的なホストアプリケーションは存在しない**
- **エミュレーター完成後にCLIツールを開発予定**
- **エミュレーターを利用してCLIツールのデバッグ・テストを実行**

#### 開発フロー
```
Phase 1: Router Emulator開発 (完了)
    ↓
Phase 2: Virtual Modules実装
    ↓  
Phase 3: Router Emulator完成
    ↓
次段階: CLI Tool開発 (エミュレーターを利用してテスト)
```

#### CLI Tool想定機能
- **BraveJIGコマンドの簡単送信**
- **アップリンク通知の受信・表示**
- **ダウンリンクリクエストの送信**
- **JIG INFOコマンドの実行**
- **エミュレーターとの通信テスト**

## センサーデータとコマンド処理の詳細仕様

**確認日**: 2025-07-07  
**確認方法**: 仕様レビュー説明  
**状況**: エミュレーター実装要件の明確化

### センサーデータ処理

#### 1. ルーターの役割
**データ透過転送:**
- **ルーターはセンサーデータ内容を理解する必要なし**
- **モジュール→ルーター→ホストアプリへ透過的転送**
- **データ解釈はホストアプリの責任**

#### 2. エミュレーター実装要件
**詳細なデータフォーマット実装が必須:**
- **各モジュール仕様書のUplinkデータ仕様に準拠**
- **センサー別の正確なバイト配列生成**
- **例**: 加速度センサー → 仕様書通りのデータレイアウト
- **例**: 照度センサー → 仕様書通りのデータレイアウト

### ダウンリンクコマンド処理

#### 1. ルーター（エミュレーター）の処理内容
**コマンド解釈と妥当性評価:**
- **ダウンリンクコマンド内容の完全解釈**
- **各モジュール仕様書のDownlinkデータ仕様に基づく妥当性チェック**
- **例**: 照度センサーパラメータ設定要求の妥当性評価
- **適切なダウンリンクレスポンス生成**

#### 2. Device ID / Sensor ID処理
**実機 vs エミュレーター:**

**実機の動作:**
- Device ID、Sensor IDに基づいて対応モジュールにコマンド送信
- 実際の通信とルーティング

**エミュレーター簡略化:**
- **アップリンク通知**: Device IDは仮の値で可
- **ダウンリンクレスポンス**: リクエストのDevice ID、Sensor IDをコピー
- **実際のルーティングは不要**（ダミーデータのため）

#### 3. エラー判定
**ルーター側で実行:**
- SensorID不正チェック
- 未サポートCMDチェック  
- 設定値範囲外チェック
- 適切なResult値でレスポンス生成

### Phase 2実装要件まとめ

#### 必須実装項目
1. **各モジュール仕様書の詳細調査**
2. **センサー別Uplinkデータフォーマット実装**
3. **センサー別Downlinkコマンド解釈機能**
4. **コマンド妥当性チェック機能**
5. **リアルなセンサーデータ生成機能**
6. **エラーハンドリングとResult値生成**

#### 簡略化可能な項目
1. **実際のBluetooth LEルーティング**
2. **Device ID実体との対応**
3. **物理的なセンサー接続**